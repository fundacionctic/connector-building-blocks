# https://taskfile.dev

version: "3"

env:
  DATA_DASHBOARD_COMMIT: c3ec34f
  DATA_DASHBOARD_DIR: data-dashboard
  MVD_COMMIT: 8141afc
  MVD_DIR: mvd
  MVD_UI_PATH: "{{.USER_WORKING_DIR}}/{{.DATA_DASHBOARD_DIR}}"
  DC_CONNECTOR_DIR: datacellar-connector
  DC_CERTS_DIR: datacellar-certs

tasks:
  clean:
    cmds:
      - cmd: docker compose --profile ui -f {{.MVD_DIR}}/system-tests/docker-compose.yml down -v
        ignore_error: true
      - docker compose -f docker-compose-http-pull.yml down -v
      - rm -fr {{.DATA_DASHBOARD_DIR}}
      - rm -fr {{.MVD_DIR}}
      - rm -fr {{.DC_CERTS_DIR}}
      - cd {{.DC_CONNECTOR_DIR}} && gradle clean

  clone-data-dashboard:
    cmds:
      - git clone git@github.com:eclipse-edc/DataDashboard.git {{.DATA_DASHBOARD_DIR}}
      - cd {{.DATA_DASHBOARD_DIR}} && git reset --hard {{.DATA_DASHBOARD_COMMIT}}
    status:
      - test -d {{.DATA_DASHBOARD_DIR}}

  clone-mvd:
    cmds:
      - git clone git@github.com:eclipse-edc/MinimumViableDataspace.git {{.MVD_DIR}}
      - cd {{.MVD_DIR}} && git reset --hard {{.MVD_COMMIT}}
    status:
      - test -d {{.MVD_DIR}}

  build-mvd:
    deps:
      - clone-mvd
    dir: "{{.MVD_DIR}}"
    cmds:
      - gradle build -x test
    status:
      - ls {{.USER_WORKING_DIR}}/{{.MVD_DIR}}/build/libs/*.jar

  build-mvd-connector:
    deps:
      - clone-mvd
    vars:
      BUILD_MARK: "{{.USER_WORKING_DIR}}/{{.MVD_DIR}}/.build-connector.log"
    dir: "{{.MVD_DIR}}"
    cmds:
      - gradle -DuseFsVault="true" :launchers:connector:shadowJar
      - touch {{.BUILD_MARK}}
    status:
      - test -f {{.BUILD_MARK}}

  build-mvd-reg-svc:
    deps:
      - clone-mvd
    vars:
      BUILD_MARK: "{{.USER_WORKING_DIR}}/{{.MVD_DIR}}/.build-reg-svc.log"
    dir: "{{.MVD_DIR}}"
    cmds:
      - gradle -DuseFsVault="true" :launchers:registrationservice:shadowJar
      - touch {{.BUILD_MARK}}
    status:
      - test -f {{.BUILD_MARK}}

  build-mvd-all:
    cmds:
      - task: build-mvd
      - task: build-mvd-connector
      - task: build-mvd-reg-svc

  mvd-system-tests-up:
    deps:
      - build-mvd-all
      - clone-data-dashboard
    cmds:
      - docker compose --profile ui -f {{.MVD_DIR}}/system-tests/docker-compose.yml up -d --build
    status:
      - >
        test $(docker compose --profile ui -f {{.MVD_DIR}}/system-tests/docker-compose.yml ps --all --format json | 
        jq '.[] | select(.State == "exited")' | 
        jq '.Name' | 
        wc -l) -eq 1
      - >
        test $(docker compose --profile ui -f {{.MVD_DIR}}/system-tests/docker-compose.yml ps --all --format json | 
        jq '.[] | select(.State == "running")' | 
        jq '.Name' | 
        wc -l) -gt 0

  upload-test-doc:
    deps:
      - mvd-system-tests-up
    cmds:
      - >
        docker run --rm -it 
        --network host
        -v {{.USER_WORKING_DIR}}/{{.MVD_DIR}}:/mvd 
        -v {{.USER_WORKING_DIR}}/scripts:/scripts
        mcr.microsoft.com/azure-cli:2.48.1 
        /bin/bash /scripts/upload-test-doc.sh

  build-datacellar-connector:
    dir: "{{.DC_CONNECTOR_DIR}}"
    cmds:
      - gradle clean build

  create-datacellar-certs:
    vars:
      KEY_ALIAS: "datacellar"
      KEY_PASSW: "datacellar"
    cmds:
      - mkdir -p {{.USER_WORKING_DIR}}/{{.DC_CERTS_DIR}}
      - >
        docker run --rm -it 
        -v {{.USER_WORKING_DIR}}/{{.DC_CERTS_DIR}}:/out 
        -v {{.USER_WORKING_DIR}}/scripts:/scripts 
        debian:bullseye 
        /bin/bash -c "OUT_DIR=/out KEY_ALIAS={{.KEY_ALIAS}} KEY_PASSW={{.KEY_PASSW}} /scripts/create-certs.sh"
    status:
      - test -f {{.USER_WORKING_DIR}}/{{.DC_CERTS_DIR}}/*.pfx

  run-http-pull-sample-services:
    deps:
      - build-datacellar-connector
      - create-datacellar-certs
    cmds:
      - docker compose -f docker-compose-http-pull.yml up -d --build
